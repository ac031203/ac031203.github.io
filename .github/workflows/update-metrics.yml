name: Update Likes and Views
on:
  repository_dispatch:
    types: [update-likes, update-views]

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update likes/views
        run: |
          ISSUE_NUMBER=${{ github.event.client_payload.issue }}
          TYPE=${{ github.event.action }}

          if [[ "$TYPE" == "update-likes" ]]; then
            COMMENT_TEXT="Likes:"
          else
            COMMENT_TEXT="Views:"
          fi

          COMMENTS=$(curl -s -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN_1 }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments")

          COMMENT_ID=$(echo "$COMMENTS" | jq -r ".[] | select(.body | startswith(\"$COMMENT_TEXT\")) | .id")
          COUNT=$(echo "$COMMENTS" | jq -r ".[] | select(.body | startswith(\"$COMMENT_TEXT\")) | .body" | awk -F': ' '{print $2+1}')

          if [[ -z "$COUNT" || "$COUNT" == "null" ]]; then
            COUNT=1
          fi

          if [[ -n "$COMMENT_ID" && "$COMMENT_ID" != "null" ]]; then
            curl -X PATCH -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN_1 }}" \
                 -H "Accept: application/vnd.github.v3+json" \
                 -H "Content-Type: application/json" \
                 -d "{\"body\": \"$COMMENT_TEXT $COUNT\"}" \
                 "https://api.github.com/repos/${{ github.repository }}/issues/comments/${COMMENT_ID}"
          else
            curl -X POST -H "Authorization: token ${{ secrets.PERSONAL_ACCESS_TOKEN_1 }}" \
                 -H "Accept: application/vnd.github.v3+json" \
                 -H "Content-Type: application/json" \
                 -d "{\"body\": \"$COMMENT_TEXT $COUNT\"}" \
                 "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments"
          fi
